<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GemiChat</title>
  <style>
    /* ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    body { background: #181a20; color: #ececf1; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; }
    header { background: #21232b; padding: 20px; text-align: center; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid #292c36; }
    main { flex: 1; display: flex; flex-direction: column; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; }
    
    /* ì±„íŒ… ì˜ì—­ */
    .chat-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    .msg-row { display: flex; align-items: flex-end; }
    .msg-row.user { justify-content: flex-end; }
    .msg-row.ai { justify-content: flex-start; }
    
    .bubble { max-width: 70%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 1rem; word-break: break-word; }
    .bubble.user { background: #4a6ee0; color: white; border-bottom-right-radius: 4px; }
    .bubble.ai { background: #2b2d3c; color: #ececf1; border-bottom-left-radius: 4px; }
    
    .loading { color: #888; font-size: 0.9rem; margin-left: 10px; animation: blink 1.5s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    /* ì…ë ¥ ì˜ì—­ */
    .input-area { display: flex; gap: 10px; background: #20222b; padding: 10px; border-radius: 10px; align-items: center; }
    textarea { flex: 1; background: transparent; border: none; color: white; resize: none; height: 40px; padding: 10px; font-size: 1rem; outline: none; }
    
    /* íŒŒì¼ ì²¨ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .file-label { cursor: pointer; padding: 5px 10px; border-radius: 5px; transition: background 0.2s; }
    .file-label:hover { background: #333; }
    .file-icon { font-size: 1.5rem; }
    
    button { background: #4a6ee0; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #3b5bc4; }
  </style>
</head>
<body>

  <header>GemiChat ğŸ¤–</header>

  <main>
    <div id="chat" class="chat-container">
      <div class="msg-row ai"><div class="bubble ai">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? (PDF íŒŒì¼ë„ ì½ì„ ìˆ˜ ìˆì–´ìš”!)</div></div>
    </div>

    <form id="chatForm" class="input-area">
      <label class="file-label" title="PDF íŒŒì¼ ì²¨ë¶€">
        <input id="fileInput" type="file" accept="application/pdf" style="display:none;">
        <span class="file-icon">ğŸ“</span>
      </label>
      
      <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
      <button type="submit">ì „ì†¡</button>
    </form>
  </main>

  <script>
    const chatEl = document.getElementById('chat');
    const formEl = document.getElementById('chatForm');
    const inputEl = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');

    // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
    function addMessage(text, sender) {
      const row = document.createElement('div');
      row.className = `msg-row ${sender}`;
      row.innerHTML = `<div class="bubble ${sender}">${text}</div>`;
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight; // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
    }

    // ë¡œë”© í‘œì‹œ í•¨ìˆ˜
    let loadingMsg = null;
    function showLoading() {
      loadingMsg = document.createElement('div');
      loadingMsg.className = 'loading';
      loadingMsg.textContent = 'AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...';
      chatEl.appendChild(loadingMsg);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function hideLoading() {
      if (loadingMsg) { chatEl.removeChild(loadingMsg); loadingMsg = null; }
    }

    // ì „ì†¡ ì´ë²¤íŠ¸
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault(); // ìƒˆë¡œê³ ì¹¨ ë°©ì§€

      const userMsg = inputEl.value.trim();
      if (!userMsg) return;

      // 1. ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
      addMessage(userMsg, 'user');
      inputEl.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
      
      // íŒŒì¼ì´ ìˆìœ¼ë©´ íŒŒì¼ëª…ë„ ì‚´ì§ ë³´ì—¬ì£¼ê¸°
      if (fileInput.files.length > 0) {
        addMessage(`ğŸ“„ íŒŒì¼ ì²¨ë¶€: ${fileInput.files[0].name}`, 'user');
      }

      showLoading();

      try {
        // 2. FormData ë§Œë“¤ê¸° (ë°±ì—”ë“œ @RequestParam ì´ë¦„ê³¼ ë˜‘ê°™ì´ ë§ì¶°ì•¼ í•¨!)
        const formData = new FormData();
        formData.append("message", userMsg); // "message" ì´ë¦„í‘œ ë¶™ì´ê¸°
        
        if (fileInput.files.length > 0) {
          formData.append("file", fileInput.files[0]); // "file" ì´ë¦„í‘œ ë¶™ì´ê¸°
        }

        // 3. ì„œë²„ë¡œ ì „ì†¡ (í—¤ë” ì„¤ì • X - ë¸Œë¼ìš°ì €ê°€ ì•Œì•„ì„œ í•¨)
        const response = await fetch('/api/chat', {
          method: 'POST',
          body: formData
        });

        // 4. ì‘ë‹µ ì²˜ë¦¬
        if (!response.ok) throw new Error("ì„œë²„ ì—ëŸ¬");
        
        const data = await response.json();
        hideLoading();
        addMessage(data.answer, 'ai');

      } catch (error) {
        hideLoading();
        console.error(error);
        addMessage("âŒ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'ai');
      }

      // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
      fileInput.value = '';
    });

    // ì—”í„°í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            formEl.dispatchEvent(new Event('submit'));
        }
    });

    // ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

    // [ì¶”ê°€] ì´ˆê¸° ë¡œë”© ì‹œ ê³¼ê±° ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸° (GET ìš”ì²­)
    window.onload = async () => {
        inputEl.focus(); // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤

        try {
            // 1. ì„œë²„ì—ê²Œ "ê¸°ë¡ ì¤˜(GET)" ìš”ì²­
            // (ì£¼ì˜: ChatControllerì— @GetMappingì´ ë§Œë“¤ì–´ì ¸ ìˆì–´ì•¼ í•¨!)
            const res = await fetch('/api/chat'); 
            
            if (!res.ok) return; // ì—ëŸ¬ë‚˜ë©´ ë¬´ì‹œ

            const history = await res.json();

            // 2. ë°›ì•„ì˜¨ ê¸°ë¡ì„ í•˜ë‚˜ì”© í™”ë©´ì— ê·¸ë¦¬ê¸°
            history.forEach(item => {
                // ì§ˆë¬¸(User) ê·¸ë¦¬ê¸°
                if (item.question) addMessage(item.question, 'user');
                // ë‹µë³€(AI) ê·¸ë¦¬ê¸°
                if (item.answer) addMessage(item.answer, 'ai');
            });
        } catch (err) {
            console.error("ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        }
    };
  </script>

</body>
</html>